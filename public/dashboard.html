<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ENJOY | لوحة التحكم</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
  <style>
    :root { --accent: #faa61a; --bg: #1e1f22; --card: #2c2f33; --text: #dbdee1; --muted: #949ba4; }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background: var(--bg); color: var(--text); font-family: 'Cairo', sans-serif; min-height:100vh; }
    .protected { text-align:center; padding:100px; }
    .protected h1 { color:#ed4245; font-size:50px; }
    #app { display:none; }

    /* التصميم الفخم */
    .header { background:#2c2f33; padding:20px; text-align:center; border-bottom:4px solid var(--accent); }
    .header h1 { color:var(--accent); font-size:36px; }

    .main { padding:40px; max-width:600px; margin:0 auto; text-align:center; }
    #avatar { width:140px; height:140px; border-radius:50%; border:6px solid var(--accent); box-shadow:0 0 40px rgba(250,166,26,0.5); margin-bottom:20px; }
    #username { font-size:32px; color:var(--accent); margin:20px 0; font-weight:900; }

    .timer-box {
      background:#1a1b1e; padding:40px; border-radius:20px; margin:30px 0;
      border:2px solid var(--accent);
    }
    .timer { font-size:70px; color:var(--accent); font-family:'Courier New', monospace; font-weight:bold; letter-spacing:5px; }

    .btns { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin:40px 0; }
    .btn {
      padding:20px; font-size:22px; border:none; border-radius:16px; cursor:pointer; font-weight:700; transition:0.3s;
    }
    .start { background:#43b581; }
    .pause { background:#fee75c; color:#000; }
    .resume { background:#43b581; }
    .stop { background:#ed4245; grid-column:1/3; }

    .total { background:#1a1b1e; padding:20px; border-radius:16px; font-size:20px; margin-top:30px; border:1px solid var(--accent); }

    .history { margin-top:50px; }
    .history h3 { color:var(--accent); margin-bottom:20px; }
    .hist-item {
      background:#2c2f33; padding:15px; border-radius:12px; margin:10px 0;
      border-right:5px solid var(--accent); font-size:16px;
    }

    .notif {
      position:fixed; top:20px; left:50%; transform:translateX(-50%);
      background:var(--accent); color:#000; padding:15px 40px; border-radius:12px;
      font-weight:bold; z-index:9999; display:none; animation:pop 0.5s;
    }
    @keyframes pop { from { transform:translate(-50%, -100px); opacity:0; } to { transform:translateX(-50%); opacity:1; } }
  </style>
</head>
<body>

  <!-- رسالة الحماية (لو دخل بدون تسجيل دخول) -->
  <div class="protected" id="protected">
    <h1>غير مصرح لك بالدخول</h1>
    <p style="font-size:20px;margin:30px 0">يجب تسجيل الدخول عبر Discord أولاً</p>
    <button onclick="location.href='/'" style="padding:15px 40px;background:#5865f2;color:white;border:none;border-radius:12px;font-size:18px;cursor:pointer">
      العودة لتسجيل الدخول
    </button>
  </div>

  <!-- التطبيق الكامل -->
  <div id="app">
    <div class="header"><h1>ENJOY</h1></div>
    <div class="main">
      <img id="avatar" src="" alt="Avatar">
      <div id="username">جاري التحميل...</div>

      <div class="timer-box">
        <div class="timer" id="sessionTimer">00:00:00</div>
        <div style="color:#949ba4;margin-top:10px">وقت الجلسة الحالية</div>
      </div>

      <div class="btns">
        <button class="btn start" id="startBtn">ابدأ العمل</button>
        <button class="btn pause" id="pauseBtn" disabled>إيقاف مؤقت</button>
        <button class="btn resume" id="resumeBtn" style="display:none">استئناف</button>
        <button class="btn stop" id="stopBtn" disabled>إنهاء الدوام</button>
      </div>

      <div class="total">
        إجمالي ساعات العمل: <strong id="totalTime">00:00:00</strong>
      </div>

      <div class="history">
        <h3>سجل الجلسات السابقة</h3>
        <div id="historyList"></div>
      </div>

      <button onclick="location.href='/logout'" style="margin-top:50px;padding:15px 40px;background:#7289da;color:white;border:none;border-radius:12px;font-size:18px">
        تسجيل الخروج
      </button>
    </div>
  </div>

  <div class="notif" id="notif"></div>

  <script>
    const notif = document.getElementById('notif');
    function show(msg) { notif.textContent = msg; notif.style.display = 'block'; setTimeout(() => notif.style.display = 'none', 3000); }

    let userData = null;
    let sessionStart = null;
    let pausedTime = 0;
    let pauseStart = null;
    let timer, warn;

    async function init() {
      const res = await fetch('/api/user');
      const data = await res.json();
      if (!data || !data.user) return location.href = '/';

      userData = data;
      document.getElementById('protected').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      document.getElementById('username').textContent = data.user.tag;
      document.getElementById('avatar').src = data.user.avatar;

      renderHistory();

      if (data.stats.currentSession) {
        sessionStart = data.stats.currentSession.start;
        pausedTime = data.stats.currentSession.pausedTime || 0;
        pauseStart = data.stats.currentSession.isPaused ? data.stats.currentSession.pauseStart : null;
        document.getElementById('startBtn').disabled = true;
        document.getElementById('pauseBtn').disabled = !pauseStart;
        document.getElementById('resumeBtn').style.display = pauseStart ? 'block' : 'none';
        document.getElementById('stopBtn').disabled = false;
        startTimer();
      }
    }

    function format(s) {
      const h = String(Math.floor(s/3600)).padStart(2,'0');
      const m = String(Math.floor((s%3600)/60)).padStart(2,'0');
      const sec = String(s%60).padStart(2,'0');
      return `${h}:${m}:${sec}`;
    }

    function startTimer() {
      clearInterval(timer); clearInterval(warn);
      timer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - sessionStart - pausedTime) / 1000);
        document.getElementById('sessionTimer').textContent = format(elapsed);
        document.getElementById('totalTime').textContent = format(userData.stats.totalSeconds + elapsed);
      }, 500);

      warn = setInterval(() => {
        if (!pauseStart) {
          const elapsed = Math.floor((Date.now() - sessionStart - pausedTime) / 1000);
          if (elapsed > 0 && elapsed % 1800 === 0) {
            new Audio('https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3').play();
            show('لا تنسَ تسجيل الخروج!');
          }
        }
      }, 1000);
    }

    function renderHistory() {
      const list = document.getElementById('historyList');
      list.innerHTML = '';
      (userData.stats.sessions || []).slice().reverse().forEach(s => {
        const div = document.createElement('div');
        div.className = 'hist-item';
        div.textContent = `${s.date} → ${format(s.duration)}`;
        list.appendChild(div);
      });
    }

    document.getElementById('startBtn').onclick = async () => {
      await fetch('/api/start', {method:'POST'});
      sessionStart = Date.now(); pausedTime = 0;
      document.getElementById('startBtn').disabled = true;
      document.getElementById('pauseBtn').disabled = false;
      document.getElementById('stopBtn').disabled = false;
      startTimer();
      show('تم تسجيل الدخول');
    };

    document.getElementById('pauseBtn').onclick = async () => {
      await fetch('/api/pause', {method:'POST'});
      pauseStart = Date.now();
      document.getElementById('pauseBtn').style.display = 'none';
      document.getElementById('resumeBtn').style.display = 'block';
      show('تم الإيقاف المؤقت');
    };

    document.getElementById('resumeBtn').onclick = async () => {
      await fetch('/api/resume', {method:'POST'});
      pausedTime += Date.now() - pauseStart;
      pauseStart = null;
      document.getElementById('pauseBtn').style.display = 'block';
      document.getElementById('resumeBtn').style.display = 'none';
      show('تم الاستئناف');
    };

    document.getElementById('stopBtn').onclick = async () => {
      if (!confirm('متأكد من تسجيل الخروج؟')) return;
      await fetch('/api/stop', {method:'POST'});
      clearInterval(timer); clearInterval(warn);
      show('تم تسجيل الخروج بنجاح');
      setTimeout(() => location.href = '/logout', 2000);
    };

    init();
  </script>
</body>
</html>
